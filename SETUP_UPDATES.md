# Setup Script Updates - Client Build Integration

## Summary

The setup scripts have been updated to automatically build the Delirium client (TypeScript to JavaScript) as part of the deployment process.

## Changes Made

### 1. Updated `scripts/setup.sh`
Added a new `build_client()` function that:
- Checks if the client repository exists
- Verifies Node.js/npm are installed
- Installs client dependencies
- Builds TypeScript to JavaScript
- Validates the output

The function is called automatically during setup, before Docker deployment.

**Location in script:** Lines 313-381

**Integration point:** Line 776 (called before `setup_docker()`)

### 2. Updated `scripts/vps-deploy.sh`
Modified the client build step to:
- Check if client directory exists
- Build client if available
- Skip gracefully if not found

**Location in script:** Lines 180-189

### 3. Created `scripts/build-client.sh`
New standalone script for building the client:
- Can be run independently
- Provides detailed output and verification
- Suggests Docker restart if needed
- Includes error handling and troubleshooting

**Usage:**
```bash
./scripts/build-client.sh
```

### 4. Updated Documentation

#### `DEPLOYMENT_STATUS.md`
- Added client rebuild steps to update procedures
- Added "Quick Client Rebuild" section

#### `CLIENT_BUILD_GUIDE.md` (New)
Comprehensive guide covering:
- Why build is required
- Multiple build methods
- Prerequisites
- Development workflow
- Troubleshooting
- Production considerations

#### `BUTTON_FIX.md` (Created earlier)
Documents the original button issue and solution.

## Why This Was Needed

### The Problem
The Delirium client is written in TypeScript, but browsers can only execute JavaScript. The HTML files reference compiled JavaScript modules:

```html
<script type="module" src="js/app.js"></script>
```

Without building, these files don't exist, causing:
- ❌ Buttons not working
- ❌ No interactivity
- ❌ JavaScript errors in browser console

### The Solution
Automatically compile TypeScript to JavaScript during setup:

```
src/app.ts  →  [TypeScript Compiler]  →  js/app.js
```

## Usage Examples

### New Installation
```bash
cd .
./scripts/setup.sh
```
The setup script will now:
1. Clone repositories (if needed)
2. **Build client** ← NEW
3. Deploy with Docker
4. Run health checks

### Rebuild Client Only
```bash
./scripts/build-client.sh
```

### Manual Build
```bash
cd ../delerium-client
npm install
npm run build
```

### Update Deployment
```bash
# Pull latest code
cd ../delerium-client
git pull

# Rebuild
npm install
npm run build

# Restart web container
cd ./docker-compose
docker compose -f docker-compose.yml -f docker-compose.prod.yml restart web
```

## Prerequisites

### Required for Client Build
- **Node.js** 18+ (v20+ recommended)
- **npm** (included with Node.js)

### Installation
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# Verify
node --version
npm --version
```

## Build Process

### What Happens
1. **Install dependencies**: `npm install`
   - Downloads required packages
   - Sets up development tools

2. **Compile TypeScript**: `npm run build`
   - Reads `tsconfig.json` configuration
   - Compiles `src/**/*.ts` → `js/**/*.js`
   - Generates source maps for debugging

3. **Output verification**
   - Checks `js/` directory exists
   - Counts generated files
   - Lists main modules

### Build Output
```
delerium-client/
├── js/                    ← Generated by build
│   ├── app.js
│   ├── delete.js
│   ├── security.js
│   ├── core/
│   ├── features/
│   ├── infrastructure/
│   ├── ui/
│   └── utils/
└── src/                   ← Original TypeScript
    ├── app.ts
    ├── delete.ts
    └── ...
```

## Error Handling

### Setup Script Behavior
The `build_client()` function is **non-fatal**:
- If Node.js is missing → Warning, continues
- If client repo missing → Warning, continues
- If build fails → Warning, continues

This allows deployment to proceed even if client build isn't available (e.g., using pre-built images).

### Build Script Behavior
The standalone `build-client.sh` is **strict**:
- Missing Node.js → Error, exits
- Missing client repo → Error, exits
- Build failure → Error, exits

This ensures you know immediately if there's a problem.

## Testing

### Verify Build Works
```bash
# Run build script
./scripts/build-client.sh

# Check output
ls -la ../delerium-client/js/

# Test in browser
curl https://delerium.cc/js/app.js
```

### Verify Buttons Work
1. Visit https://delerium.cc
2. Try clicking buttons (Create Paste, Copy, etc.)
3. Check browser console for errors (F12)

## Rollback

If you need to revert these changes:

```bash
cd .
git log --oneline  # Find commit before changes
git revert <commit-hash>
```

Or manually remove the `build_client()` function from `setup.sh`.

## Future Improvements

### Potential Enhancements
1. **Docker build integration**: Build client inside Docker image
2. **Build caching**: Cache node_modules for faster builds
3. **Minification**: Add JavaScript minification for production
4. **Version checking**: Verify Node.js version meets requirements
5. **Parallel builds**: Build client and server simultaneously

### Production Optimization
Consider creating a multi-stage Dockerfile:
```dockerfile
# Stage 1: Build client
FROM node:20-alpine AS client-builder
WORKDIR /app
COPY delerium-client/package*.json ./
RUN npm ci
COPY delerium-client/ ./
RUN npm run build

# Stage 2: Serve with nginx
FROM nginx:alpine
COPY --from=client-builder /app/js /usr/share/nginx/html/js
COPY --from=client-builder /app/*.html /usr/share/nginx/html/
```

## Support

### Documentation
- [Setup Guide](SETUP_GUIDE.md)
- [Client Build Guide](CLIENT_BUILD_GUIDE.md)
- [Deployment Guide](DEPLOYMENT.md)
- [Button Fix Documentation](BUTTON_FIX.md)

### Troubleshooting
See [CLIENT_BUILD_GUIDE.md](CLIENT_BUILD_GUIDE.md#troubleshooting) for common issues and solutions.

---
**Updated:** 2025-11-18  
**Version:** 1.0.0  
**Author:** Infrastructure Team
