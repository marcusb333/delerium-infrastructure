# Infrastructure Integration Tests
# File: delerium-infrastructure/.github/workflows/integration-tests.yml
# Version: 1.0.0
#
# This workflow runs integration tests across all Delirium components.
# It tests the full deployment stack with Docker Compose.

name: Integration Tests

on:
  # Run on schedule (daily)
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      client_version:
        description: 'Client version to test'
        required: false
        default: 'latest'
      server_version:
        description: 'Server version to test'
        required: false
        default: 'latest'
  
  # Run on pull requests to main
  pull_request:
    branches: 
      - main

# Cancel in-progress runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Integration Test - Full Stack
  # =============================================================================
  integration-test:
    name: Full Stack Integration
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config:
          - name: "Development"
            compose_file: "docker-compose.yml:docker-compose.dev.yml"
            port: 8080
          - name: "Production"
            compose_file: "docker-compose.yml:docker-compose.prod.yml"
            port: 80
    steps:
      - name: Checkout infrastructure repository
        uses: actions/checkout@v4
        with:
          path: infrastructure

      - name: Checkout client repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/delerium-client
          ref: ${{ github.event.inputs.client_version || 'main' }}
          path: delerium-client

      - name: Checkout server repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/delerium-server
          ref: ${{ github.event.inputs.server_version || 'main' }}
          path: delerium-server

      - name: Setup environment
        working-directory: infrastructure
        run: |
          # Create .env file
          cp docker-compose/.env.example .env
          
          # Generate secure pepper
          echo "DELETION_TOKEN_PEPPER=$(openssl rand -hex 32)" >> .env
          echo "GITHUB_USERNAME=${{ github.repository_owner }}" >> .env
          echo "CLIENT_DIST=../../delerium-client" >> .env
          
          # Create directories
          mkdir -p data logs

      - name: Start services (${{ matrix.config.name }})
        working-directory: infrastructure
        run: |
          # Start Docker Compose
          IFS=':' read -ra FILES <<< "${{ matrix.config.compose_file }}"
          COMPOSE_CMD="docker compose"
          for file in "${FILES[@]}"; do
            COMPOSE_CMD="$COMPOSE_CMD -f docker-compose/$file"
          done
          
          echo "Starting: $COMPOSE_CMD"
          $COMPOSE_CMD up -d --build

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to start..."
          
          # Wait up to 2 minutes for services
          timeout=120
          elapsed=0
          
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:${{ matrix.config.port }}/api/health 2>/dev/null; then
              echo "✅ Services are healthy!"
              exit 0
            fi
            
            echo "Waiting... ($elapsed/$timeout seconds)"
            sleep 5
            elapsed=$((elapsed + 5))
          done
          
          echo "❌ Services failed to start within $timeout seconds"
          docker compose -f infrastructure/docker-compose/docker-compose.yml logs
          exit 1

      - name: Run smoke tests
        run: |
          BASE_URL="http://localhost:${{ matrix.config.port }}"
          
          echo "Testing PoW endpoint..."
          curl -f $BASE_URL/api/pow || exit 1
          
          echo "Testing static files..."
          curl -f $BASE_URL/ || exit 1
          
          echo "Testing paste creation flow..."
          # Create a test paste (encrypted)
          RESPONSE=$(curl -s -X POST $BASE_URL/api/pastes \
            -H "Content-Type: application/json" \
            -d '{
              "ct": "test-encrypted-content",
              "iv": "test-iv",
              "meta": {"exp": 3600}
            }')
          
          # Extract paste ID
          PASTE_ID=$(echo $RESPONSE | grep -oP '(?<="id":")[^"]*')
          
          if [ -z "$PASTE_ID" ]; then
            echo "❌ Failed to create paste"
            exit 1
          fi
          
          echo "✅ Created paste: $PASTE_ID"
          
          # Retrieve paste
          curl -f $BASE_URL/api/pastes/$PASTE_ID || exit 1
          echo "✅ Retrieved paste successfully"
          
          echo "All smoke tests passed! ✅"

      - name: Run end-to-end tests (Client E2E suite)
        working-directory: delerium-client
        run: |
          # Install dependencies
          npm ci
          
          # Install Playwright
          npx playwright install --with-deps chromium
          
          # Run E2E tests against running stack
          npx playwright test --config playwright.config.ts \
            --project=chromium \
            --base-url=http://localhost:${{ matrix.config.port }}

      - name: Collect logs on failure
        if: failure()
        working-directory: infrastructure
        run: |
          echo "Collecting Docker logs..."
          docker compose -f docker-compose/docker-compose.yml logs > integration-logs.txt
          
          echo "Collecting service status..."
          docker compose -f docker-compose/docker-compose.yml ps >> integration-logs.txt

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-logs-${{ matrix.config.name }}
          path: infrastructure/integration-logs.txt
          retention-days: 7

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results-${{ matrix.config.name }}
          path: delerium-client/playwright-report/
          retention-days: 7

      - name: Cleanup
        if: always()
        working-directory: infrastructure
        run: |
          docker compose -f docker-compose/docker-compose.yml down -v
          docker system prune -f

  # =============================================================================
  # Performance Test
  # =============================================================================
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: integration-test
    steps:
      - name: Checkout infrastructure repository
        uses: actions/checkout@v4
        with:
          path: infrastructure

      - name: Checkout repositories
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/delerium-client
          path: delerium-client

      - name: Checkout server repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/delerium-server
          path: delerium-server

      - name: Setup and start services
        working-directory: infrastructure
        run: |
          cp docker-compose/.env.example .env
          echo "DELETION_TOKEN_PEPPER=$(openssl rand -hex 32)" >> .env
          echo "CLIENT_DIST=../../delerium-client" >> .env
          
          docker compose -f docker-compose/docker-compose.yml up -d --build
          
          # Wait for services
          timeout 60 bash -c 'until curl -f http://localhost:8080/api/health; do sleep 2; done'

      - name: Install k6 (load testing tool)
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg \
            --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | \
            sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run performance tests
        run: |
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          
          export const options = {
            stages: [
              { duration: '30s', target: 20 },
              { duration: '1m', target: 20 },
              { duration: '20s', target: 0 },
            ],
            thresholds: {
              http_req_duration: ['p(95)<500'],
              http_req_failed: ['rate<0.1'],
            },
          };
          
          export default function () {
            // Test PoW endpoint
            const powRes = http.get('http://localhost:8080/api/pow');
            check(powRes, { 'PoW endpoint success': (r) => r.status === 200 || r.status === 204 });
            
            // Test paste creation
            const payload = JSON.stringify({
              ct: 'test-content',
              iv: 'test-iv',
              meta: { exp: 3600 }
            });
            
            const params = { headers: { 'Content-Type': 'application/json' } };
            const createRes = http.post('http://localhost:8080/api/pastes', payload, params);
            check(createRes, { 'Paste creation success': (r) => r.status === 200 });
            
            sleep(1);
          }
          EOF
          
          k6 run load-test.js

      - name: Cleanup
        if: always()
        working-directory: infrastructure
        run: docker compose -f docker-compose/docker-compose.yml down -v

# Workflow run summary
# This workflow:
# 1. Runs full stack integration tests (dev + prod configs)
# 2. Performs smoke tests on all API endpoints
# 3. Runs client E2E test suite against running stack
# 4. Runs performance/load tests with k6
# 5. Collects logs and artifacts on failure
