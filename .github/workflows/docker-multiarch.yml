# Multi-Architecture Docker Build Workflow
# File: delerium-infrastructure/.github/workflows/docker-multiarch.yml
# Version: 2.0.0
#
# This workflow builds and publishes multi-architecture Docker images
# for the Delirium server to both Docker Hub and GitHub Container Registry.
# Supports: linux/amd64, linux/arm64, linux/arm/v7
# Updated: 2025-11-18 - Latest action versions and JDK 21

name: Build Multi-Arch Docker Images

on:
  # Trigger on version tags
  push:
    tags:
      - 'v*.*.*-*'
      - 'server-v*.*.*'
  
  # Trigger on main branch pushes
  push:
    branches:
      - main
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for the image'
        required: true
        default: 'latest'
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        default: 'linux/amd64,linux/arm64,linux/arm/v7'
      push_to_registry:
        description: 'Push to registries'
        required: false
        type: boolean
        default: true

# Cancel in-progress runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: delerium-server
  PLATFORMS: linux/amd64,linux/arm64,linux/arm/v7

jobs:
  # =============================================================================
  # Build and Push Multi-Architecture Images
  # =============================================================================
  build-multiarch:
    name: Build Multi-Arch Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
      - name: Checkout infrastructure repository
        uses: actions/checkout@v4.2.2
        with:
          path: infrastructure

      - name: Checkout server repository
        uses: actions/checkout@v4.2.2
        with:
          repository: ${{ github.repository_owner }}/delerium-server
          path: delerium-server

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.2.0
        with:
          platforms: ${{ github.event.inputs.platforms || env.PLATFORMS }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.7.1
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Extract metadata
        id: meta
        run: |
          # Determine version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#server-}"  # Remove 'server-' prefix if present
          else
            VERSION="latest"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
          echo "sha_short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          
          # Determine platforms
          PLATFORMS="${{ github.event.inputs.platforms || env.PLATFORMS }}"
          echo "platforms=${PLATFORMS}" >> $GITHUB_OUTPUT
          
          echo "Building version: ${VERSION}"
          echo "Platforms: ${PLATFORMS}"

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3.3.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push to Docker Hub
        if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false')
        uses: docker/build-push-action@v6.9.0
        with:
          context: ./delerium-server
          file: ./delerium-server/Dockerfile
          platforms: ${{ steps.meta.outputs.platforms }}
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.title=Delirium Paste Server
            org.opencontainers.image.description=Zero-knowledge encrypted paste service backend
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.created=${{ steps.meta.outputs.date }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Build and push to GHCR
        if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false')
        uses: docker/build-push-action@v6.9.0
        with:
          context: ./delerium-server
          file: ./delerium-server/Dockerfile
          platforms: ${{ steps.meta.outputs.platforms }}
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.title=Delirium Paste Server
            org.opencontainers.image.description=Zero-knowledge encrypted paste service backend
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.created=${{ steps.meta.outputs.date }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Build only (no push)
        if: github.event_name == 'pull_request' || github.event.inputs.push_to_registry == 'false'
        uses: docker/build-push-action@v6.9.0
        with:
          context: ./delerium-server
          file: ./delerium-server/Dockerfile
          platforms: ${{ steps.meta.outputs.platforms }}
          push: false
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Inspect images
        if: github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false')
        run: |
          echo "==================================="
          echo "Docker Hub Image Manifest"
          echo "==================================="
          docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} || true
          
          echo ""
          echo "==================================="
          echo "GHCR Image Manifest"
          echo "==================================="
          docker buildx imagetools inspect ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }} || true

      - name: Generate build summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Multi-Architecture Build Summary
          
          ### Build Information
          - **Version**: \`${{ steps.meta.outputs.version }}\`
          - **Platforms**: \`${{ steps.meta.outputs.platforms }}\`
          - **Commit**: \`${{ steps.meta.outputs.sha_short }}\`
          - **Date**: \`${{ steps.meta.outputs.date }}\`
          
          ### Images Published
          $(if [ "${{ github.event_name }}" != "pull_request" ] && [ "${{ github.event.inputs.push_to_registry }}" != "false" ]; then
            echo "- Docker Hub: \`${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}\`"
            echo "- GHCR: \`ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}\`"
          else
            echo "- **Build only** (images not pushed)"
          fi)
          
          ### Usage
          \`\`\`bash
          # Pull from Docker Hub
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          
          # Pull from GHCR
          docker pull ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          
          # Run on any architecture
          docker run -d -p 8080:8080 \\
            -e DELETION_TOKEN_PEPPER=your-secret \\
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          \`\`\`
          
          ### Supported Architectures
          - ✅ AMD64 (x86_64) - Intel/AMD processors
          - ✅ ARM64 (aarch64) - Apple Silicon, AWS Graviton, Raspberry Pi 4+
          - ✅ ARMv7 - Raspberry Pi 3, older ARM devices
          EOF

  # =============================================================================
  # Test Multi-Architecture Images
  # =============================================================================
  test-multiarch:
    name: Test on ${{ matrix.platform }}
    needs: build-multiarch
    if: github.event_name != 'pull_request'
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: ubuntu-latest
    
    steps:
      - name: Set up QEMU
        if: matrix.platform != 'linux/amd64'
        uses: docker/setup-qemu-action@v3.2.0

      - name: Extract metadata
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#server-}"
          else
            VERSION="latest"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Pull and test image
        run: |
          echo "Testing ${{ matrix.platform }} image..."
          
          # Pull the image
          docker pull --platform ${{ matrix.platform }} \
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          
          # Run the container
          docker run -d --name test-container \
            --platform ${{ matrix.platform }} \
            -e DELETION_TOKEN_PEPPER=test-secret \
            -p 8080:8080 \
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          
          # Wait for service to be ready
          echo "Waiting for service to start..."
          for i in {1..30}; do
            if curl -f http://localhost:8080/api/pow 2>/dev/null; then
              echo "✅ Service is healthy on ${{ matrix.platform }}"
              docker stop test-container
              exit 0
            fi
            sleep 2
          done
          
          echo "❌ Service failed to start on ${{ matrix.platform }}"
          docker logs test-container
          docker stop test-container
          exit 1

# Workflow Summary:
# 1. Builds multi-architecture Docker images for AMD64, ARM64, and ARMv7
# 2. Pushes to both Docker Hub and GitHub Container Registry
# 3. Tests images on different architectures
# 4. Generates comprehensive build summary
# 5. Supports manual triggers with custom parameters
